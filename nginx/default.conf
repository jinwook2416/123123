server {
    listen 80;
    server_name jinwook.mjsec.kr;

    # 1. Certbot 인증용 통로 (이게 살아있어야 인증서가 나옵니다)
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # 2. 인증서 받기 전까지는 리다이렉트를 잠시 끄고 Flask 연결을 80포트에 둡니다.
    location /jinwook/ {
        proxy_pass http://web:5000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 기존의 301 리다이렉트(HTTPS 강제 이동)는 인증서를 받은 후에 켭니다.
    # location / {
    #     return 301 https://$host$request_uri;
    # }
}

# 아래 443 서버 블록은 인증서가 없으면 Nginx를 죽게 만드므로 통째로 주석 처리합니다.
# server {
#     listen 443 ssl;
#     server_name jinwook.mjsec.kr;
#
#     ssl_certificate /etc/letsencrypt/live/jinwook.mjsec.kr/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/jinwook.mjsec.kr/privkey.pem;
#
#     location /jinwook/ {
#         proxy_pass http://web:5000/;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#     }
# }